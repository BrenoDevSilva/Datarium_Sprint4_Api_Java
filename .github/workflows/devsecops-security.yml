name: DevSecOps Security Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build_app:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/datarium-api-0.0.1-SNAPSHOT.jar

  sast-analysis:
    name: Static Analysis (SpotBugs)
    runs-on: ubuntu-latest
    needs: build_app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Run SpotBugs
        run: mvn clean verify

      - name: Upload SpotBugs Reports
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: |
            target/spotbugsXml.xml
            target/site/spotbugs.html

  dependency-check:
    name: Dependency Check (OWASP)
    runs-on: ubuntu-latest
    needs: build_app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Run OWASP Dependency Check
        run: mvn org.owasp:dependency-check-maven:check || true

      - name: Upload Dependency Check Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html

  dast-analysis:
    name: Dynamic Analysis (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: build_app

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./build

      - name: Run Application
        run: |
          nohup java -jar ./build/datarium-api-0.0.1-SNAPSHOT.jar &
          sleep 15

      - name: Run OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:8080'
          fail_action: false
          allow_issue_writing: false
          cmd_options: '-a'

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report_html.html

  security-report:
    name: Consolidated Security Report
    runs-on: ubuntu-latest
    needs: [sast-analysis, dependency-check, dast-analysis]

    steps:
      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          path: ./reports

      - name: List Reports
        run: ls -R ./reports

      - name: Create Security Summary
        run: |
          echo "==== DevSecOps Security Summary ====" > summary.txt
          echo "" >> summary.txt
          echo "🧩 SpotBugs Results:" >> summary.txt
          grep -E 'BugCollection|BugInstance' ./reports/spotbugs-report/target/spotbugsXml.xml | head -n 10 >> summary.txt || echo "No issues found" >> summary.txt
          echo "" >> summary.txt
          echo "📦 Dependency Check Summary:" >> summary.txt
          grep -E 'Vulnerability|dependency' ./reports/dependency-check-report/target/dependency-check-report.html | head -n 10 >> summary.txt || echo "No issues found" >> summary.txt
          echo "" >> summary.txt
          echo "🌐 ZAP Scan Summary:" >> summary.txt
          grep -E 'Alerts|Risk' ./reports/zap-report/report_html.html | head -n 10 >> summary.txt || echo "No issues found" >> summary.txt

      - name: Upload Consolidated Summary
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-security-summary
          path: summary.txt
